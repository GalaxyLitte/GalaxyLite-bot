class SQLiteStorage:
    def __init__(self, guild_id: str):
        self.guild_id = str(guild_id)
        self.db_path = f'databases/{self.guild_id}.db'
        self.ensure_directory()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –ë–î
        if not os.path.exists(self.db_path):
            print(f"üìÅ –°–æ–∑–¥–∞–µ–º –ë–î –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ {self.guild_id}")
            self.init_database()
        else:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü
            self.check_tables()
    
    def ensure_directory(self):
        """–°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
        if not os.path.exists('databases'):
            try:
                os.makedirs('databases')
                print(f"üìÅ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ databases")
            except Exception as e:
                print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É: {e}")
    
    def check_tables(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –∏ –∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—É"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            # –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å
            required_tables = [
                'settings',
                'warn_settings', 
                'warnings',
                'users',
                'bad_words',
                'automod',
                'relationships',
                'relationship_proposals',
                'automod_learning',
                'automod_patterns',
                'spam_patterns',
                'message_context'
            ]
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
            cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
            existing_tables = [table[0] for table in cursor.fetchall()]
            
            missing_tables = []
            for table in required_tables:
                if table not in existing_tables:
                    missing_tables.append(table)
            
            if missing_tables:
                print(f"‚ö†Ô∏è –í –ë–î {self.guild_id} –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–∞–±–ª–∏—Ü—ã: {missing_tables}")
                # –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
                self._create_missing_tables(missing_tables)
            else:
                print(f"‚úÖ –ë–î {self.guild_id} –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞, –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –º–µ—Å—Ç–µ")
            
            conn.close()
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–∞–±–ª–∏—Ü: {e}")
            # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –ë–î
            self._recreate_database()
    
    def _create_missing_tables(self, missing_tables):
        """–°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        try:
            for table in missing_tables:
                if table == 'settings':
                    cursor.execute('''
                        CREATE TABLE settings (
                            key TEXT PRIMARY KEY,
                            value TEXT
                        )
                    ''')
                elif table == 'warn_settings':
                    cursor.execute('''
                        CREATE TABLE warn_settings (
                            key TEXT PRIMARY KEY,
                            value TEXT
                        )
                    ''')
                elif table == 'warnings':
                    cursor.execute('''
                        CREATE TABLE warnings (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            user_id TEXT,
                            moderator_id TEXT,
                            reason TEXT,
                            timestamp REAL
                        )
                    ''')
                elif table == 'users':
                    cursor.execute('''
                        CREATE TABLE users (
                            user_id TEXT PRIMARY KEY,
                            balance INTEGER DEFAULT 0,
                            daily_last_claimed REAL DEFAULT 0
                        )
                    ''')
                elif table == 'bad_words':
                    cursor.execute('''
                        CREATE TABLE bad_words (
                            word TEXT PRIMARY KEY
                        )
                    ''')
                elif table == 'automod':
                    cursor.execute('''
                        CREATE TABLE automod (
                            setting TEXT PRIMARY KEY,
                            value TEXT
                        )
                    ''')
                elif table == 'relationships':
                    cursor.execute('''
                        CREATE TABLE relationships (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            user1_id TEXT NOT NULL,
                            user2_id TEXT NOT NULL,
                            relationship_type TEXT DEFAULT 'relationship',
                            created_at REAL NOT NULL,
                            status TEXT DEFAULT 'active',
                            love_points INTEGER DEFAULT 50,
                            money_pool INTEGER DEFAULT 0,
                            divorce_requested INTEGER DEFAULT 0
                        )
                    ''')
                elif table == 'relationship_proposals':
                    cursor.execute('''
                        CREATE TABLE relationship_proposals (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            from_user_id TEXT NOT NULL,
                            to_user_id TEXT NOT NULL,
                            relationship_type TEXT DEFAULT 'relationship',
                            created_at REAL NOT NULL,
                            status TEXT DEFAULT 'pending'
                        )
                    ''')
                elif table == 'automod_learning':
                    cursor.execute('''
                        CREATE TABLE automod_learning (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            message_content TEXT,
                            action TEXT,
                            moderator_id TEXT,
                            reason TEXT,
                            severity INTEGER DEFAULT 1,
                            timestamp REAL,
                            guild_id TEXT
                        )
                    ''')
                elif table == 'automod_patterns':
                    cursor.execute('''
                        CREATE TABLE automod_patterns (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            pattern TEXT,
                            action TEXT,
                            severity INTEGER,
                            confidence REAL DEFAULT 0.5,
                            learned_from INTEGER DEFAULT 0,
                            last_used REAL
                        )
                    ''')
                elif table == 'spam_patterns':
                    cursor.execute('''
                        CREATE TABLE spam_patterns (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            user_id TEXT,
                            message_count INTEGER DEFAULT 1,
                            last_messages TEXT,
                            timestamp REAL,
                            flagged INTEGER DEFAULT 0
                        )
                    ''')
                elif table == 'message_context':
                    cursor.execute('''
                        CREATE TABLE message_context (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            user_id TEXT,
                            message TEXT,
                            timestamp REAL,
                            guild_id TEXT
                        )
                    ''')
                
                print(f"‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞: {table}")
            
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            self._add_default_data(cursor)
            
            conn.commit()
            print(f"‚úÖ –í—Å–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ {self.guild_id}")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü: {e}")
            conn.rollback()
            # –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ë–î —Å –Ω—É–ª—è
            self._recreate_database()
        finally:
            conn.close()
    
    def _add_default_data(self, cursor):
        """–î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        # –í—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–æ–¥–µ—Ä–∞—Ü–∏–∏
        default_automod = [
            ('enabled', 'true'),
            ('anti_spam', 'true'),
            ('anti_mention', 'true'),
            ('anti_caps', 'true'),
            ('anti_bad_words', 'true'),
            ('anti_repeat', 'true'),
            ('anti_emoji_spam', 'true'),
            ('anti_invites', 'true'),
            ('spam_limit', '5'),
            ('spam_time', '5'),
            ('mention_limit', '5'),
            ('caps_threshold', '0.7')
        ]
        
        # –í—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—Ä–Ω–æ–≤
        default_warn_settings = [
            ('warn1_action', 'none'),
            ('warn2_action', 'none'),
            ('warn3_action', 'mute'),
            ('warn3_duration', '3600'),  # 1 —á–∞—Å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            ('warn4_action', 'mute'),
            ('warn4_duration', '86400'),  # 24 —á–∞—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            ('warn5_action', 'ban'),
            ('warn5_duration', '0'),
            ('max_warnings', '10'),
            ('mute_role_id', 'none'),
            ('log_channel_id', 'none')
        ]
        
        try:
            cursor.executemany('''
                INSERT OR IGNORE INTO automod (setting, value) 
                VALUES (?, ?)
            ''', default_automod)
            
            cursor.executemany('''
                INSERT OR IGNORE INTO warn_settings (key, value) 
                VALUES (?, ?)
            ''', default_warn_settings)
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {e}")
    
    def _recreate_database(self):
        """–ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –ë–î —Å –Ω—É–ª—è"""
        try:
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª
            if os.path.exists(self.db_path):
                os.remove(self.db_path)
                print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –ë–î: {self.db_path}")
            
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ë–î
            self.init_database()
            print(f"‚úÖ –ë–î –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ {self.guild_id}")
            
        except Exception as e:
            print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–∏ –ë–î: {e}")
    

    def init_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS settings (
                key TEXT PRIMARY KEY,
                value TEXT
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–∞—Ä–Ω–æ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS warn_settings (
                key TEXT PRIMARY KEY,
                value TEXT
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS warnings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id TEXT,
                moderator_id TEXT,
                reason TEXT,
                timestamp REAL
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id TEXT PRIMARY KEY,
                balance INTEGER DEFAULT 0,
                daily_last_claimed REAL DEFAULT 0
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS bad_words (
                word TEXT PRIMARY KEY
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –∞–≤—Ç–æ–º–æ–¥–µ—Ä–∞—Ü–∏–∏
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS automod (
                setting TEXT PRIMARY KEY,
                value TEXT
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS relationships (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user1_id TEXT NOT NULL,
                user2_id TEXT NOT NULL,
                relationship_type TEXT DEFAULT 'relationship',
                created_at REAL NOT NULL,
                status TEXT DEFAULT 'active',
                love_points INTEGER DEFAULT 50,
                money_pool INTEGER DEFAULT 0,
                divorce_requested INTEGER DEFAULT 0
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ—Ç–Ω–æ—à–µ–Ω–∏–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS relationship_proposals (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                from_user_id TEXT NOT NULL,
                to_user_id TEXT NOT NULL,
                relationship_type TEXT DEFAULT 'relationship',
                created_at REAL NOT NULL,
                status TEXT DEFAULT 'pending'
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –æ–±—É—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–¥–µ—Ä–∞—Ü–∏–∏
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS automod_learning (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                message_content TEXT,
                action TEXT,
                moderator_id TEXT,
                reason TEXT,
                severity INTEGER DEFAULT 1,
                timestamp REAL,
                guild_id TEXT
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –ø–ª–æ—Ö–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS automod_patterns (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                pattern TEXT,
                action TEXT,
                severity INTEGER,
                confidence REAL DEFAULT 0.5,
                learned_from INTEGER DEFAULT 0,
                last_used REAL
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ —Å–ø–∞–º –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS spam_patterns (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id TEXT,
                message_count INTEGER DEFAULT 1,
                last_messages TEXT,
                timestamp REAL,
                flagged INTEGER DEFAULT 0
            )
        ''')
        
        # –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS message_context (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id TEXT,
                message TEXT,
                timestamp REAL,
                guild_id TEXT
            )
        ''')
        
        # –í—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–æ–¥–µ—Ä–∞—Ü–∏–∏
        default_automod = [
            ('enabled', 'true'),
            ('anti_spam', 'true'),
            ('anti_mention', 'true'),
            ('anti_caps', 'true'),
            ('anti_bad_words', 'true'),
            ('anti_repeat', 'true'),
            ('anti_emoji_spam', 'true'),
            ('anti_invites', 'true'),
            ('spam_limit', '5'),
            ('spam_time', '5'),
            ('mention_limit', '5'),
            ('caps_threshold', '0.7')
        ]
        
        # –í—Å—Ç–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—Ä–Ω–æ–≤
        default_warn_settings = [
            ('warn1_action', 'none'),
            ('warn2_action', 'none'),
            ('warn3_action', 'mute'),
            ('warn3_duration', '3600'),  # 1 —á–∞—Å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            ('warn4_action', 'mute'),
            ('warn4_duration', '86400'),  # 24 —á–∞—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            ('warn5_action', 'ban'),
            ('warn5_duration', '0'),
            ('max_warnings', '10'),
            ('mute_role_id', 'none'),
            ('log_channel_id', 'none')
        ]
        
        cursor.executemany('''
            INSERT OR IGNORE INTO automod (setting, value) 
            VALUES (?, ?)
        ''', default_automod)
        
        cursor.executemany('''
            INSERT OR IGNORE INTO warn_settings (key, value) 
            VALUES (?, ?)
        ''', default_warn_settings)
        
        conn.commit()
        conn.close()
